---
title: HTTPS中间人攻击
date: 2020-01-16 17:58:06
tags:
    - HTTPS
    - MITM
    - 中间人攻击
---

## 🎯 `HTTPS`的实现原理
`HTTPS`由两部分组成：`HTTP + SSL/TLS`，也就是在`HTTP`上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过`TLS`进行加密。但其实，**`HTTPS`在内容传输的加密上使用的是对称加密，非对称加密只作用在证书验证阶段**。

`HTTPS`的整体过程分为证书验证和数据传输阶段, 如下图所示：

{% asset_img https.jpg%}

<!-- more -->

**1.证书验证阶段**
- 浏览器发起`HTTPS`请求
- 服务端返回`HTTPS`证书
- 客户端验证证书是否合法，如果不合法则提示告警
  
**2.数据传输阶段**
- 当证书验证合法后，在本地生成随机数 
- 通过公钥加密随机数，并把加密后的随机数传输到服务端 
- 服务端通过私钥对随机数进行解密 
- 服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输

#### 👉 为什么数据传输是用对称加密？
首先，非对称加密的加解密效率是非常低的，而`HTTPS`的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的；另外，在`HTTPS`的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以`HTTPS`中内容传输加密采取的是对称加密，而不是非对称加密。

## 🎯 什么是中间人攻击？
**中间人攻击**（`Main-in-the-middle attack`，缩写：`MITM`）是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。在中间人攻击中，攻击者可以拦截通讯双方的通话并插入新的内容，达到`HTTPS`攻击的目的。

#### 👉 如何进行中间人攻击的呢？
我们知道，`HTTPS`在建立了`TCP`连接之后，会进行`SSL`握手（`SSL Handshake`）来校验证书，协商加密协议和对称加密的密钥，之后就会使用协商好的密钥来进行传输。所以`HTTPS`攻击一般分为`SSL`连接建立前的攻击，以及`HTTPS`传输过程中的攻击。
常见的`HTTPS`中间人攻击，首先需要结合**ARP(地址解析协议)**、**DNS欺骗**等技术，来对会话进行拦截。

### 攻击一：SSLSniff(SSL证书欺骗攻击)
此类攻击较为简单常见。首先通过`ARP`欺骗、`DNS`劫持甚至网关劫持等等，将客户端的访问重定向到攻击者的机器，让客户端机器与攻击者机器建立`HTTPS`连接（使用伪造证书），而攻击者机器再跟服务端连接。这样用户在客户端看到的是相同域名的网站，但浏览器会提示证书不可信，用户不点击继续浏览就能避免被劫持的。所以这是最简单的攻击方式，也是最容易识别的攻击方式。

{% asset_img mitm.png%}

#### 👉 浏览器如何保证证书的合法性？
浏览器发起`HTTPS`请求时，服务器会返回网站的`HTTPS`证书，浏览器需要对证书做以下验证：
1. 检查证书是否是**“受信任的根证书颁发机构”**颁发。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证。
2. 检查`SSL`证书中的证书吊销列表，判断证书是否已吊销
3. 检查此`SSL`证书是否过期
4. 验证域名等信息是否正确，证书上都有包含这些信息，比较容易完成验证

#### 👉 只有认证机构可以生成证书吗？
如果需要浏览器不提示安全风险，那只能使用认证机构签发的证书。但浏览器通常只是提示安全风险，并不限制网站不能访问，所以从技术上谁都可以生成证书，只要有证书就可以完成网站的`HTTPS`传输。例如早期的`12306`采用的便是手动安装私有证书的形式实现`HTTPS`访问。

#### 👉 本地随机数被窃取怎么办？
证书验证是采用非对称加密实现，但是传输过程是采用对称加密，而其中对称加密算法中重要的随机数是由本地生成并且存储于本地的，`HTTPS`如何保证随机数不会被窃取？
其实`HTTPS`并不包含对随机数的安全保证，`HTTPS`保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。

#### 👉 用了HTTPS会被抓包吗?
`HTTPS`的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是我们自己的终端，我们授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常`HTTPS`抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。

### 攻击二：SSLStrip(SSL剥离攻击)
这种攻击相对于攻击一复杂一点，但是也更加厉害，几乎可以在客户端无感知的情况下实施攻击，并且不需要伪造证书。简单来说就是这样：中间人在客户端与服务器建立连接时，在中间人与服务器之间形成`HTTPS`连接，而在客户端与中间人之间形成`HTTP`连接，即将`SSL`层从原`HTTPS`连接中“剥离”。这样，既避免了在客户端验证证书时难以避免的弹框问题，又能够劫持`HTTP`明文数据，并同时保证客户端`HTTP`数据的传输，达到欺骗服务器与客户端的效果。

{% asset_img sslstrip.webp%}

**🙌 具体过程如下：**
用户在浏览器地址栏中输入网址时，多数会采用直接输入网址的方式，而忽略了传输所采用的协议。例如，在登录`gmail`过程中，大多数用户会直接在地址栏中输入`www.gmail.com`，向`Google`服务器发送一个`HTTP`连接请求，而不是输入`https://www.gmail.com`， 向服务器发送一个`HTTPS`连接请求。因此，用户通常接触到`HTTPS`的方式有两种：一种是`Web`上的连接，比如当用户在`gmail`上输入用户名和密码后，点击的登录键，将用户的用户名和密码以`HTTPS`的形式POST到服务器。另一种是通过`HTTP`的302状态。 当客户端向`gmail`提出HTTP连接请求时，`gmail`服务器会返回一个重定向网址，`https://www.google.com/accounts/ServiceLogin?service=mail...`，用户端在接收到这个`URL`后，将页面重定位到该网页，并请求`HTTPS`连接。 从另外一个角度讲，用户通常是通过`HTTP`向服务器发起`HTTPS`连接的。而`HTTP`本身是以明文的形式对外传送，并不能保证数据的安全。因此，可以考虑通过对HTTP进行劫持，来实现对`HTTPS`劫持的目的。

1. 客户端向服务器发起`HTTP`连接请求
2. 中间人`MITM`监听客户端与服务器的`HTTP`数据
3. 服务器返回给客户端的`HTTP`数据包被在客户端与服务器之间的中间人截获。中间人解析原`HTTP`数据包，将其中`<a href="https：//...">`替换成`<a href="http//...">`，将`Location:https://...`替换成`Location:http://..`，同时记录下所修改的`URL`，并保存
4. 中间人将修改后的`HTTP`数据发送给客户端
5. 客户端向服务器发起`HTTP`连接请求
6. 中间人计算机解析客户端的`HTTP`连接请求，并与保存文件相比较。当发现存在有已修改过的`HTTP URL`时，将其替换成原`HTTPS URL`，并发送给服务器
7. 与服务器保持`HTTPS`连接，回到步骤3；
8. 与客户端保持`HTTP`连接，回到步骤4。

最后结果是服务器认为`HTTPS`是安全的。对于客户端而言，由于中间人`MITM`与客户端`Client`之间是`HTTP`连接，因此并不会对证书进行认证。

为了解决这个问题，`IETF`（互联网工程任务小组）引入了一个策略，叫做`HSTS`(`HTTP Strict Transport Security`, `HTTP`严格传输安全)。`HSTS`的作用是强制客户端与服务端建立安全的`HTTPS`连接，而非不安全的`HTTP`连接。如果一个站点启用了`HSTS`策略，那么客户端在第一次与该站点建立连接之后，在未来的一段时间内（由一个`HTTP`头部控制，这个头部为：`Strict-Transport-Security`），客户端与该站点的所有连接都会直接使用`HTTPS`，即使客户端访问的是`HTTP`，也会直接在客户端重定向到`HTTPS`连接。

假设`https://example.com`的响应头部含有`Strict-Transport-Security: max-age=31536000; includeSubDomains`，这意味着：
- 在未来的一年时间里（即`31536000`秒中），只要浏览器向`example.com`或者其子域名发送请求，必须采用`HTTPS`来发起连接。即使用户在地址栏里写的是`http://example.com`，那也直接重写为`https://example.com`并直接发起`HTTPS`连接。
- 在接下去的一年中，如果服务器提供的`HTTPS`证书无效（不论是域名对不上还是自签名还是不在有效期内），用户都无法访问该站点。
如果站点没有启用`HSTS`，用户可以忽略证书无效的警告，继续建立连接，而如果站点启用了`HSTS`，那么用户即使想冒风险，浏览器也不会继续访问。

`HSTS`可以很大程度上防止`SSLTrip`攻击，不过这样还是有个问题，那就是要启用`HSTS`，浏览器至少要和服务器建立一次`HTTPS`连接，如果中间人一直阻止浏览器与服务器建立`HTTPS`连接，那么`HSTS`就失效了。解决这个问题有个办法，那就是将`HSTS`站点列表内置到浏览器中，这样只要浏览器离线判断该站点启用了`HSTS`，就会跳过原先的`HTTP`重定向，直接发起`HTTPS`请求。

### 攻击三：针对SSL/TSL算法进行攻击
上述两种方式，技术含量较低，而且一般只能影响`WebApp`，而很难攻击到`Native App`， 所以高阶的`Hacker`，会直接针对`SSL`算法相关漏洞进行攻击，期间会使用很多的密码学相关手段。比如说利用[OpenSSL漏洞](https://zhuanlan.zhihu.com/p/19722474)。

这类攻击手段是利用`SSL`算法的相关漏洞，所以最好的防范措施就是对服务端`SSL/TLS`的配置进行升级：
- 只支持尽量高版本的`TLS`（最低`TLS1`）
- 禁用一些已爆出安全隐患的加密方法
- 使用2048位的数字证书






> 参考链接：
> [HTTPS中间人攻击及防御](https://elliotsomething.github.io/2016/12/22/HTTPS%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E5%8F%8A%E9%98%B2%E5%BE%A1/)
> [HTTPS原理和中间人攻击](https://www.i5seo.com/https-yuan-li-he-zhong-jian-ren-gong-ji.html)




